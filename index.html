<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chronos 數位觀課儀表板</title>
    <!-- 核心套件：使用 React 18 穩定版本 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #020617; /* Slate-950 */
            color: #f8fafc;
            margin: 0;
            overflow: hidden;
            height: 100vh;
        }
        .glass-panel {
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(245, 158, 11, 0.1);
        }
        .klimt-gradient {
            background: linear-gradient(135deg, #f59e0b 0%, #b45309 50%, #7c2d12 100%);
        }
        .rust-gradient {
            background: linear-gradient(135deg, #991b1b 0%, #7f1d1d 100%);
        }
        @keyframes rotate-slow {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-rotate-slow {
            animation: rotate-slow 10s linear infinite;
        }
        .idle-alert {
            animation: pulse-border 2s infinite;
        }
        @keyframes pulse-border {
            0% { border-color: rgba(245, 158, 11, 0.2); }
            50% { border-color: rgba(245, 158, 11, 0.8); box-shadow: 0 0 15px rgba(245, 158, 11, 0.4); }
            100% { border-color: rgba(245, 158, 11, 0.2); }
        }
        ::-webkit-scrollbar {
            width: 4px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(245, 158, 11, 0.3);
            border-radius: 10px;
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;

        // --- 常數定義 ---
        const TeachingMode = {
            LECTURE: '講述教學',
            DISCUSSION: '小組討論',
            PRACTICE: '實作/演算',
            DIGITAL: '數位運用'
        };

        const TeachingAction = {
            ENCOURAGEMENT: '正向鼓勵',
            CORRECTION: '糾正規範',
            OPEN_Q: '開放提問',
            CLOSED_Q: '封閉提問',
            PATROL: '巡視走動'
        };

        // --- 圖標元件 ---
        const StartIcon = ({ className }) => (
            <svg viewBox="0 0 100 100" className={className}>
                <defs>
                    <linearGradient id="grad-gold" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style={{ stopColor: '#fef3c7', stopOpacity: 1 }} />
                        <stop offset="100%" style={{ stopColor: '#d97706', stopOpacity: 1 }} />
                    </linearGradient>
                </defs>
                <circle cx="50" cy="50" r="45" fill="none" stroke="url(#grad-gold)" strokeWidth="1" strokeDasharray="4 4" className="animate-rotate-slow" />
                <polygon points="40,30 75,50 40,70" fill="url(#grad-gold)" />
            </svg>
        );

        const StopIcon = ({ className }) => (
            <svg viewBox="0 0 100 100" className={className}>
                <defs>
                    <linearGradient id="grad-rust" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style={{ stopColor: '#ef4444', stopOpacity: 1 }} />
                        <stop offset="100%" style={{ stopColor: '#7f1d1d', stopOpacity: 1 }} />
                    </linearGradient>
                </defs>
                <rect x="25" y="25" width="50" height="50" rx="4" fill="url(#grad-rust)" />
            </svg>
        );

        // --- 結算模態框 ---
        const SummaryModal = ({ session, subject, onClose, onReset }) => {
            const formatDuration = (s) => `${Math.floor(s/60)}分 ${s%60}秒`;
            
            const getReport = () => {
                let r = `【Chronos 數位觀課報告】\n科目: ${subject}\n日期: ${new Date().toLocaleDateString('zh-TW')}\n時間: ${session.startTime?.toLocaleTimeString('zh-TW', { hour12: false })} - ${session.endTime?.toLocaleTimeString('zh-TW', { hour12: false })}\n\n`;
                r += "== [1] 教學模式累計時間 ==\n" + Object.entries(session.modeDurations).map(([m, d]) => `${m}: ${formatDuration(d)}`).join('\n');
                r += "\n\n== [2] 教學行為細節統計 ==\n" + Object.values(TeachingAction).map(a => `${a}: ${session.actionCounts[a]}次 | ${formatDuration(session.actionDurations[a])}`).join('\n');
                r += "\n\n== [3] 詳細紀錄流 ==\n" + session.logs.map(l => `[${l.timestamp.toLocaleTimeString('zh-TW', { hour12: false })}] ${l.label}`).join('\n');
                return r;
            };

            const downloadTxt = () => {
                const content = getReport();
                // \uFEFF 是 UTF-8 的 BOM，確保 Windows 記事本能正確識別繁體中文
                const blob = new Blob(['\uFEFF' + content], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                const dateStr = new Date().toISOString().split('T')[0];
                link.href = url;
                link.download = `Chronos觀課紀錄_${subject}_${dateStr}.txt`;
                link.click();
                URL.revokeObjectURL(url);
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-950/90 backdrop-blur-md">
                    <div className="glass-panel w-full max-w-2xl rounded-3xl overflow-hidden border border-amber-500/30">
                        <div className="p-6 klimt-gradient text-white flex justify-between items-center">
                            <h2 className="text-xl font-bold tracking-widest">觀課結算</h2>
                            <button onClick={onClose} className="text-2xl">✕</button>
                        </div>
                        <div className="p-8 space-y-4 max-h-[60vh] overflow-y-auto">
                            <div className="grid grid-cols-2 gap-4">
                                {Object.entries(session.modeDurations).map(([m, d]) => (
                                    <div key={m} className="bg-slate-900 p-3 rounded">
                                        <div className="text-xs text-slate-500">{m}</div>
                                        <div className="text-amber-500 font-mono">{formatDuration(d)}</div>
                                    </div>
                                ))}
                            </div>
                            <div className="space-y-2">
                                {Object.values(TeachingAction).map(a => (
                                    <div key={a} className="flex justify-between bg-slate-900 p-3 rounded">
                                        <span>{a}</span>
                                        <span className="text-blue-400">{session.actionCounts[a]} 次 / {formatDuration(session.actionDurations[a])}</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                        <div className="p-6 bg-slate-900 flex gap-4 justify-end">
                            <button onClick={downloadTxt} className="px-6 py-2 klimt-gradient text-slate-950 font-bold rounded-xl shadow-lg flex items-center gap-2 transition-transform active:scale-95">
                                <svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                下載紀錄 (.txt)
                            </button>
                            <button onClick={() => window.location.reload()} className="px-4 py-2 bg-red-800 text-white rounded-xl font-bold">重新開始</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- 主程式 ---
        const App = () => {
            const [session, setSession] = useState({
                isActive: false, startTime: null, endTime: null, currentMode: null, currentAction: null,
                modeDurations: Object.fromEntries(Object.values(TeachingMode).map(m => [m, 0])),
                actionCounts: Object.fromEntries(Object.values(TeachingAction).map(a => [a, 0])),
                actionDurations: Object.fromEntries(Object.values(TeachingAction).map(a => [a, 0])),
                logs: [], engagement: 'MID', lastActivity: Date.now()
            });
            const [subject, setSubject] = useState('國文');
            const [showSummary, setShowSummary] = useState(false);
            const [isIdle, setIsIdle] = useState(false);
            const [now, setNow] = useState(new Date());
            const timerRef = useRef(null);
            const longPressRef = useRef(null);

            useEffect(() => {
                const clock = setInterval(() => setNow(new Date()), 1000);
                return () => clearInterval(clock);
            }, []);

            useEffect(() => {
                if (session.isActive) {
                    timerRef.current = setInterval(() => {
                        setSession(prev => {
                            const next = { ...prev };
                            if (prev.currentMode) next.modeDurations[prev.currentMode]++;
                            if (prev.currentAction) next.actionDurations[prev.currentAction]++;
                            if (Date.now() - prev.lastActivity > 300000) setIsIdle(true);
                            return next;
                        });
                    }, 1000);
                } else {
                    clearInterval(timerRef.current);
                }
                return () => clearInterval(timerRef.current);
            }, [session.isActive]);

            const log = (label) => {
                setSession(p => ({
                    ...p, lastActivity: Date.now(),
                    logs: [{ id: Date.now(), timestamp: new Date(), label }, ...p.logs].slice(0, 50)
                }));
                setIsIdle(false);
            };

            const handleAction = (action, isLong) => {
                if (!session.isActive) return;
                if (isLong) {
                    const starting = session.currentAction !== action;
                    setSession(p => ({ ...p, currentAction: starting ? action : null }));
                    log(starting ? `開始計時: ${action}` : `停止計時: ${action}`);
                } else {
                    setSession(p => ({ ...p, actionCounts: { ...p.actionCounts, [action]: p.actionCounts[action] + 1 } }));
                    log(`記錄行為: ${action}`);
                }
            };

            return (
                <div className="flex flex-col h-screen w-full bg-slate-950 overflow-hidden">
                    {/* Top Bar */}
                    <header className="h-16 border-b border-amber-500/20 glass-panel flex items-center justify-between px-6 shrink-0">
                        <div className="flex items-center gap-4">
                            <h1 className="text-amber-500 font-bold tracking-widest">CHRONOS</h1>
                            <select value={subject} onChange={e => setSubject(e.target.value)} disabled={session.isActive} className="bg-slate-900 border border-amber-500/20 text-sm px-2 py-1 rounded">
                                {['國文','英文','數學','自然','社會'].map(s => <option key={s}>{s}</option>)}
                            </select>
                        </div>
                        <div className="flex items-center gap-6">
                            <span className="font-mono text-amber-400 hidden sm:block">{now.toLocaleTimeString('zh-TW', { hour12: false })}</span>
                            <button onClick={() => {
                                if (!session.isActive) {
                                    setSession(p => ({ ...p, isActive: true, startTime: new Date() }));
                                    log("開始觀課");
                                } else {
                                    setSession(p => ({ ...p, isActive: false, endTime: new Date(), currentMode: null, currentAction: null }));
                                    setShowSummary(true);
                                }
                            }} className={`px-6 py-2 rounded-full font-bold flex items-center gap-2 transition-transform active:scale-95 ${session.isActive ? 'rust-gradient' : 'klimt-gradient'}`}>
                                {session.isActive ? <><StopIcon className="w-4 h-4"/> 結束</> : <><StartIcon className="w-4 h-4"/> 開始</>}
                            </button>
                        </div>
                    </header>

                    {/* Dashboard */}
                    <main className="flex-1 p-4 grid grid-cols-1 md:grid-cols-12 gap-4 overflow-hidden">
                        <div className="md:col-span-4 space-y-4">
                            <h2 className="text-amber-500/60 text-xs font-bold tracking-widest uppercase">模式 (States)</h2>
                            {Object.values(TeachingMode).map(m => (
                                <button key={m} onClick={() => {
                                    if (!session.isActive) return;
                                    const sw = session.currentMode !== m;
                                    setSession(p => ({ ...p, currentMode: sw ? m : null }));
                                    log(sw ? `模式: ${m}` : `停止: ${m}`);
                                }} className={`w-full p-4 rounded-xl border text-left flex justify-between items-center transition-all ${session.currentMode === m ? 'klimt-gradient border-amber-400 scale-[1.02]' : 'bg-slate-900/50 border-white/5 opacity-60'}`}>
                                    <span className="font-bold">{m}</span>
                                    <span className="font-mono">{Math.floor(session.modeDurations[m]/60)}:{String(session.modeDurations[m]%60).padStart(2,'0')}</span>
                                </button>
                            ))}
                        </div>

                        <div className="md:col-span-8 flex flex-col gap-4 overflow-hidden">
                            <h2 className="text-amber-500/60 text-xs font-bold tracking-widest uppercase">行為 (Actions) <span className="lowercase italic opacity-40 ml-2">長按切換計時</span></h2>
                            <div className="grid grid-cols-3 md:grid-cols-5 gap-2">
                                {Object.values(TeachingAction).map(a => (
                                    <button key={a} 
                                        onMouseDown={() => { longPressRef.current = setTimeout(() => { handleAction(a, true); longPressRef.current = null; }, 500); }}
                                        onMouseUp={() => { if(longPressRef.current){ clearTimeout(longPressRef.current); handleAction(a, false); } }}
                                        onTouchStart={() => { longPressRef.current = setTimeout(() => { handleAction(a, true); longPressRef.current = null; }, 500); }}
                                        onTouchEnd={() => { if(longPressRef.current){ clearTimeout(longPressRef.current); handleAction(a, false); } }}
                                        className={`p-2 rounded-lg border flex flex-col items-center transition-all ${session.currentAction === a ? 'bg-blue-600 border-blue-400 animate-pulse' : 'bg-slate-900 border-white/10'}`}>
                                        <span className="text-[10px] opacity-70">{a}</span>
                                        <span className="text-lg font-mono font-bold">{session.actionCounts[a]}</span>
                                        <span className="text-[10px] font-mono opacity-50">{Math.floor(session.actionDurations[a]/60)}:{String(session.actionDurations[a]%60).padStart(2,'0')}</span>
                                    </button>
                                ))}
                            </div>
                            <div className="flex-1 glass-panel rounded-2xl p-4 overflow-y-auto font-mono text-xs space-y-2">
                                {session.logs.map(l => (
                                    <div key={l.id} className="border-b border-white/5 pb-1 opacity-70">
                                        <span className="text-amber-500">[{l.timestamp.toLocaleTimeString()}]</span> {l.label}
                                    </div>
                                ))}
                            </div>
                        </div>
                    </main>

                    {/* Footer */}
                    <footer className={`h-16 border-t border-amber-500/20 glass-panel px-6 flex items-center justify-between shrink-0 transition-all ${isIdle ? 'idle-alert' : ''}`}>
                        <div className="flex gap-2">
                            {['LOW','MID','HIGH'].map(v => (
                                <button key={v} onClick={() => { setSession(p => ({ ...p, engagement: v })); log(`專注度: ${v}`); }} className={`px-3 py-1 rounded text-[10px] font-bold ${session.engagement === v ? 'bg-amber-500 text-black' : 'bg-white/5'}`}>{v}</button>
                            ))}
                        </div>
                        <input type="text" placeholder="快速備註..." onKeyDown={e => { if(e.key==='Enter' && e.target.value.trim()){ log(`備註: ${e.target.value}`); e.target.value=''; }}} className="flex-1 mx-6 bg-white/5 border border-white/10 rounded-full px-4 py-1 text-sm outline-none focus:border-amber-500" />
                    </footer>

                    {showSummary && <SummaryModal session={session} subject={subject} onClose={() => setShowSummary(false)} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>